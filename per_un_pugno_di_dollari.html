<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Per un pugno di dollari</title>
<style>
body{margin:0;font-family:Georgia, serif;background:linear-gradient(to bottom,#3a2c1a,#1a1208);color:#f5e6c4;}
.container{display:flex;gap:40px;padding:40px;}
.poster img{width:300px;border:5px solid #d4af37;box-shadow:0 0 20px black;}
h2,h3{color:#d4af37;text-shadow:2px 2px 5px black;}
a{color:#ffd700;text-decoration:none}a:hover{text-decoration:underline}
.info{max-width:700px}
textarea{width:100%;padding:10px;margin-top:10px;background:#2c1c0e;color:white;border:1px solid #d4af37;}
button{background:#5a3e1b;color:white;border:none;padding:8px 14px;margin-top:8px;cursor:pointer;}
button:hover{background:#8b5a2b}
.comment{background:#2c1c0e;padding:10px;margin-top:10px;border-left:3px solid #d4af37;}
.reply{margin-left:30px;border-left:3px solid #aaa;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;}
.hidden{display:none;}
.modal-box{background:#1b1b1b;padding:30px;width:400px;position:relative;border:2px solid #d4af37;}
.close{position:absolute;right:10px;top:10px;cursor:pointer;color:red;font-size:20px;}
.stars span{font-size:25px;cursor:pointer;color:#999;}
.stars span:hover{color:gold;}
</style>
</head>
<body>

<div class="container">
  <div class="poster">
    <img src="https://upload.wikimedia.org/wikipedia/en/8/8c/A_Fistful_of_Dollars.jpg" alt="Per un pugno di dollari">
    <h2>Per un pugno di dollari</h2>
  </div>

  <div class="info">
    <p><b>–ì–æ–¥ –≤—ã—Ö–æ–¥–∞:</b> 1964</p>
    <p><b>–°—Ç—Ä–∞–Ω–∞:</b> –ò—Ç–∞–ª–∏—è, –ò—Å–ø–∞–Ω–∏—è, –ì–µ—Ä–º–∞–Ω–∏—è (–§–†–ì)</p>
    <p><b>–ñ–∞–Ω—Ä:</b> –í–µ—Å—Ç–µ—Ä–Ω</p>
    <p><b>–†–µ–∂–∏—Å—Å–µ—Ä:</b> –°–µ—Ä–¥–∂–∏–æ –õ–µ–æ–Ω–µ</p>
    <p><b>–í —Ä–æ–ª—è—Ö:</b> –ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥, –î–∂–∞–Ω –ú–∞—Ä–∏—è –í–æ–ª–æ–Ω—Ç–µ, –ú–∞—Ä–∏–∞–Ω–Ω–∞ –ö–æ—Ö, –í–æ–ª—å—Ñ–≥–∞–Ω–≥ –õ—É–∫—à–∏, –ó–∏–≥—Ö–∞—Ä–¥—Ç –†—É–ø–ø, –ô–æ–∑–µ—Ñ –≠–≥–≥–µ—Ä, Antonio Prieto, –•–æ—Å–µ –ö–∞–ª—å–≤–æ, –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –õ–æ—Å–∞–Ω–æ, –î–∞–Ω–∏—ç–ª—å –ú–∞—Ä—Ç–∏–Ω</p>
    <p><b>IMDb:</b> 7.9 / <b>–ö–∏–Ω–æ–ø–æ–∏—Å–∫:</b> 7.98</p>
    <p><b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> –í –º–∞–ª–µ–Ω—å–∫–æ–º –≥–æ—Ä–æ–¥–∫–µ –∏–¥–µ—Ç –≤–æ–π–Ω–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –≤–ª–∏—è—Ç–µ–ª—å–Ω—ã–º–∏ —Å–µ–º–µ–π—Å—Ç–≤–∞–º–∏, –∫–æ—Ç–æ—Ä—ã—Ö –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∑–∞–∫–æ–Ω. –ì–µ—Ä–æ–π –ö–ª–∏–Ω—Ç–∞ –ò—Å—Ç–≤—É–¥–∞ ‚Äî —á–µ–ª–æ–≤–µ–∫ –±–µ–∑ –∏–º–µ–Ω–∏, —É–º–µ—é—â–∏–π —Å—Ç—Ä–µ–ª—è—Ç—å –±–µ–∑ –ø—Ä–æ–º–∞—Ö–∞...</p>
    <p><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> <span id="views">0</span></p>

    <h3>–§–∏–ª—å–º</h3>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/Ox0H_uohPYM" allowfullscreen></iframe>

    <h3>–û—Ü–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å–º</h3>
    <div class="stars">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
    </div>
    –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: <span id="avgRating">0.0</span> (<span id="votesCount">0</span> –≥–æ–ª–æ—Å–æ–≤)

    <h3>–í—Ö–æ–¥</h3>
    <input id="nickname" placeholder="–í–∞—à –Ω–∏–∫">
    <button onclick="login()">–í–æ–π—Ç–∏</button>

    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
    <div id="comments"></div>
    <textarea id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
    <button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<div id="modal" class="modal hidden">
  <div class="modal-box">
    <span class="close" onclick="closeModal()">‚úñ</span>
    <textarea id="modalText"></textarea>
    <button onclick="saveReply()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
let votingInProgress = {};
let currentUser = null;
let replyTo = null;

firebase.initializeApp({
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c"
});

const db = firebase.firestore();
const movieKey = "per_un_pugno_di_dollari"; 
const movieRef = db.collection("movies").doc(movieKey);
const commentsRef = movieRef.collection("comments");
const votesRef = movieRef.collection("votes");
const statsRef = movieRef.collection("stats");
const ratingRef = statsRef.doc("rating");

// ===== –í–•–û–î =====
async function login(){
  const nick = document.getElementById("nickname").value.trim();
  if(!nick) return;
  currentUser = nick;
  localStorage.setItem("nickname", nick);
  alert("–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+nick);
  loadRating();
  countView();
}

// ===== –ü–†–û–°–ú–û–¢–†–´ =====
async function countView(){
  if(localStorage.getItem("viewed_"+movieKey)) return;
  const ref = statsRef.doc("views");
  await ref.set({count:0},{merge:true});
  await ref.update({count: firebase.firestore.FieldValue.increment(1)});
  localStorage.setItem("viewed_"+movieKey,"yes");
  const snap = await ref.get();
  document.getElementById("views").innerText = snap.data().count || 0;
}

// ===== –†–ï–ô–¢–ò–ù–ì =====
async function loadRating(){
  const snap = await ratingRef.get();
  if(!snap.exists) await ratingRef.set({totalScore:0,totalVotes:0});
  const data = (await ratingRef.get()).data();
  document.getElementById("avgRating").innerText = data.totalVotes ? (data.totalScore/data.totalVotes).toFixed(1) : "0.0";
  document.getElementById("votesCount").innerText = data.totalVotes;
}

document.querySelectorAll(".star").forEach(star=>{
  star.onclick = async ()=>{
    if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
    const voteKey = "rated_"+movieKey+"_"+currentUser;
    if(localStorage.getItem(voteKey)) return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏!");
    const value = parseInt(star.dataset.value);
    await ratingRef.update({
      totalScore: firebase.firestore.FieldValue.increment(value),
      totalVotes: firebase.firestore.FieldValue.increment(1)
    });
    localStorage.setItem(voteKey,"yes");
    loadRating();
  };
});

// ===== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò =====
commentsRef.orderBy("created").onSnapshot(snapshot=>{
  const all = {};
  snapshot.forEach(doc=>all[doc.id] = {id:doc.id,...doc.data()});
  document.getElementById("comments").innerHTML="";
  Object.values(all).filter(c=>!c.parent).forEach(c=>renderComment(c,all));
});

function renderComment(comment, all, parentDiv=null){
  const div = document.createElement("div");
  div.className="comment";
  if(comment.parent) div.classList.add("reply");

  div.innerHTML=`
    <b>${comment.user}</b>
    <p>${comment.text}</p>
    <button onclick="like('${comment.id}')">üëç ${comment.likes||0}</button>
    <button onclick="dislike('${comment.id}')">üëé ${comment.dislikes||0}</button>
    <button onclick="openReply('${comment.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    ${currentUser===comment.user ? `<button onclick="deleteComment('${comment.id}')">–£–¥–∞–ª–∏—Ç—å</button>`:""}
  `;

  (parentDiv||document.getElementById("comments")).appendChild(div);
  Object.values(all).filter(c=>c.parent===comment.id).forEach(child=>renderComment(child,all,div));
}

// ===== ADD COMMENT =====
async function addComment(parent=null,text=null){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  const value = text || document.getElementById("commentInput").value;
  if(!value) return;
  await commentsRef.add({
    user: currentUser,
    text: value,
    parent: parent||null,
    likes:0,
    dislikes:0,
    created:Date.now()
  });
  document.getElementById("commentInput").value="";
}

// ===== LIKE/DISLIKE =====
async function like(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  if(votingInProgress[id]) return; votingInProgress[id]=true;
  const voteDoc = votesRef.doc(currentUser+"_"+id);
  const voteSnap = await voteDoc.get();
  if(voteSnap.exists){
    const oldType = voteSnap.data().type;
    if(oldType==="like"){ 
      await commentsRef.doc(id).update({likes: firebase.firestore.FieldValue.increment(-1)});
      await voteDoc.delete(); votingInProgress[id]=false; return;
    }
    if(oldType==="dislike"){
      await commentsRef.doc(id).update({dislikes: firebase.firestore.FieldValue.increment(-1), likes: firebase.firestore.FieldValue.increment(1)});
      await voteDoc.update({type:"like"}); votingInProgress[id]=false; return;
    }
  }
  await commentsRef.doc(id).update({likes: firebase.firestore.FieldValue.increment(1)});
  await voteDoc.set({type:"like"});
  votingInProgress[id]=false;
}

async function dislike(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  if(votingInProgress[id]) return; votingInProgress[id]=true;
  const voteDoc = votesRef.doc(currentUser+"_"+id);
  const voteSnap = await voteDoc.get();
  if(voteSnap.exists){
    const oldType = voteSnap.data().type;
    if(oldType==="dislike"){
      await commentsRef.doc(id).update({dislikes: firebase.firestore.FieldValue.increment(-1)});
      await voteDoc.delete(); votingInProgress[id]=false; return;
    }
    if(oldType==="like"){
      await commentsRef.doc(id).update({likes: firebase.firestore.FieldValue.increment(-1), dislikes: firebase.firestore.FieldValue.increment(1)});
      await voteDoc.update({type:"dislike"}); votingInProgress[id]=false; return;
    }
  }
  await commentsRef.doc(id).update({dislikes: firebase.firestore.FieldValue.increment(1)});
  await voteDoc.set({type:"dislike"});
  votingInProgress[id]=false;
}

// ===== DELETE =====
async function deleteComment(id){
  const doc = await commentsRef.doc(id).get();
  if(!doc.exists) return;
  if(doc.data().user!==currentUser) return alert("–ù–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
  await commentsRef.doc(id).delete();
}

// ===== REPLY =====
function openReply(id){ replyTo=id; document.getElementById("modal").classList.remove("hidden"); }
function closeModal(){ document.getElementById("modal").classList.add("hidden"); }
async function saveReply(){ const text=document.getElementById("modalText").value; if(text) await addComment(replyTo,text); document.getElementById("modalText").value=""; closeModal(); }

// ===== –ê–í–¢–û–í–•–û–î =====
window.onload = async ()=>{
  const savedNick = localStorage.getItem("nickname");
  if(savedNick){ currentUser=savedNick; console.log("–í–æ—à–ª–∏ –∫–∞–∫ "+currentUser);}
  loadRating();
  countView();
}
</script>

</body>
</html>
