<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–ª–ª–∞—Ä–æ–≤ –±–æ–ª—å—à–µ</title>
<style>
body{
  margin:0;
  font-family:Georgia, serif;
  background:linear-gradient(to bottom,#3a2c1a,#1a1208);
  color:#f5e6c4;
}
.container{
  display:flex;
  gap:40px;
  padding:40px;
}
.poster img{
  width:300px;
  border:5px solid #d4af37;
  box-shadow:0 0 20px black;
}
h2,h3{color:#d4af37; text-shadow:2px 2px 5px black;}
a{color:#ffd700;text-decoration:none}
a:hover{text-decoration:underline}
.info{max-width:700px}
textarea{width:100%;padding:10px;margin-top:10px;background:#2c1c0e;color:white;border:1px solid #d4af37;}
button{background:#5a3e1b;color:white;border:none;padding:8px 14px;margin-top:8px;cursor:pointer;}
button:hover{background:#8b5a2b}
.comment{background:#2c1c0e;padding:10px;margin-top:10px;border-left:3px solid #d4af37;}
.reply{margin-left:30px;border-left:3px solid #aaa;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;}
.hidden{display:none;}
.modal-box{background:#1b1b1b;padding:30px;width:400px;position:relative;border:2px solid #d4af37;}
.close{position:absolute;right:10px;top:10px;cursor:pointer;color:red;font-size:20px;}
.stars span{font-size:25px;cursor:pointer;color:#999;}
.stars span:hover{color:gold;}
</style>
</head>
<body>

<div class="container">
<div class="poster">
<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTCxtEljwymUbifbP48s0ryFIgLy1OYI-j4mQ&s">
<h2>–ó–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–ª–ª–∞—Ä–æ–≤ –±–æ–ª—å—à–µ</h2>
</div>

<div class="info">
<p><b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b> 
<a href="https://www.imdb.com/title/tt0059578/" target="_blank">
For a Few Dollars More
</a></p>

<p><b>–°—Ç—Ä–∞–Ω–∞:</b> <a href="https://ru.wikipedia.org/wiki/–ò—Ç–∞–ª–∏—è" target="_blank">–ò—Ç–∞–ª–∏—è</a>, <a href="https://ru.wikipedia.org/wiki/–ò—Å–ø–∞–Ω–∏—è" target="_blank">–ò—Å–ø–∞–Ω–∏—è</a></p>
<p><b>–ñ–∞–Ω—Ä:</b> <a href="https://ru.wikipedia.org/wiki/–í–µ—Å—Ç–µ—Ä–Ω" target="_blank">–í–µ—Å—Ç–µ—Ä–Ω</a></p>
<p><b>–†–µ–∂–∏—Å—Å–µ—Ä:</b> <a href="https://ru.wikipedia.org/wiki/–õ–µ–æ–Ω–µ,_–°–µ—Ä–¥–∂–æ" target="_blank">–°–µ—Ä–¥–∂–∏–æ –õ–µ–æ–Ω–µ</a></p>
<p><b>–í –≥–ª–∞–≤–Ω—ã—Ö —Ä–æ–ª—è—Ö:</b><br>
<a href="https://ru.wikipedia.org/wiki/–ò—Å—Ç–≤—É–¥,_–ö–ª–∏–Ω—Ç" target="_blank">–ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥</a><br>
<a href="https://ru.wikipedia.org/wiki/–í–∞–Ω_–ö–ª–∏—Ñ,_–õ–∏" target="_blank">–õ–∏ –í–∞–Ω –ö–ª–∏—Ñ</a>
</p>
<p><b>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</b> 1965</p>
<p><b>IMDb:</b> 8.2 / <b>–ö–∏–Ω–æ–ø–æ–∏—Å–∫:</b> 8.2</p>
<p><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> <span id="views">0</span></p>

<h3>–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞</h3>
<p> –¥–≤–æ–µ –≥–æ–ª–æ–≤–æ—Ä–µ–∑–æ–π –±–ª–æ–Ω–¥–∏–Ω –∏ –∞–Ω–≥–µ–ª—å—Å–∫–∏–µ –≥–ª–∞–∑–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –±–µ–∑—É–º–Ω–æ–≥–æ –≥–ª–∞–≤–∞—Ä—è –±–∞–Ω–¥—ã –ò–Ω–¥–µ–π—Ü–∞, –ø—Ä–µ—Å–ª–µ–¥—É—è –∫–∞–∫ –Ω–∞–≥—Ä–∞–¥—É, —Ç–∞–∫ –∏ –ª–∏—á–Ω—É—é –º–µ—Å—Ç—å.</p>


<h3>–§–∏–ª—å–º</h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/K3ZawLSra-w"  allowfullscreen></iframe>
 
<h3>–û—Ü–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å–º</h3>
<div class="stars">
<span class="star" data-value="1">‚òÖ</span>
<span class="star" data-value="2">‚òÖ</span>
<span class="star" data-value="3">‚òÖ</span>
<span class="star" data-value="4">‚òÖ</span>
<span class="star" data-value="5">‚òÖ</span>
</div>
–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: <span id="avgRating">0.0</span> (<span id="votesCount">0</span> –≥–æ–ª–æ—Å–æ–≤)

<h3>–í—Ö–æ–¥</h3>
<input id="nickname" placeholder="–í–∞—à –Ω–∏–∫">
<button onclick="login()">–í–æ–π—Ç–∏</button>
<span id="loginError" style="color:red"></span>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<div id="comments"></div>
<textarea id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
<button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

</div>
</div>

<div id="modal" class="modal hidden">
<div class="modal-box">
<span class="close" onclick="closeModal()">‚úñ</span>
<textarea id="modalText"></textarea>
<button onclick="saveReply()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
  let votingInProgress = {};

firebase.initializeApp({
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c"
});

const db = firebase.firestore();

const movieKey = "dollars_more";

const movieRef = db.collection("movies").doc(movieKey);
const commentsRef = movieRef.collection("comments");
const votesRef = movieRef.collection("votes");
const statsRef = movieRef.collection("stats");

let currentUser = null;
let replyTo = null;

/* ===== –í–•–û–î ===== */
async function login(){
  const nick = document.getElementById("nickname").value.trim();
  if(!nick) return;

  currentUser = nick;
  localStorage.setItem("nickname", nick);

  alert("–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ " + nick);
  loadRating();
  countView();
}

/* ===== –ü–†–û–°–ú–û–¢–†–´ ===== */
async function countView(){
  if(localStorage.getItem("viewed_"+movieKey)) return;

  const ref = statsRef.doc("views");

  await ref.set({count:0}, {merge:true});
  await ref.update({
    count: firebase.firestore.FieldValue.increment(1)
  });

  localStorage.setItem("viewed_"+movieKey,"yes");

  const snap = await ref.get();
  document.getElementById("views").innerText = snap.data().count || 0;
}

/* ===== –†–ï–ô–¢–ò–ù–ì ===== */
const ratingRef = statsRef.doc("rating");

async function loadRating(){
  const snap = await ratingRef.get();

  if(!snap.exists){
    await ratingRef.set({totalScore:0,totalVotes:0});
  }

  const data = (await ratingRef.get()).data();
  const avg = data.totalVotes 
    ? (data.totalScore/data.totalVotes).toFixed(1) 
    : "0.0";

  document.getElementById("avgRating").innerText = avg;
  document.getElementById("votesCount").innerText = data.totalVotes;
}

document.querySelectorAll(".star").forEach(star=>{
  star.onclick = async ()=>{
    if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

    const voteKey = "rated_"+movieKey+"_"+currentUser;
    if(localStorage.getItem(voteKey))
      return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏!");

    const value = parseInt(star.dataset.value);

    await ratingRef.update({
      totalScore: firebase.firestore.FieldValue.increment(value),
      totalVotes: firebase.firestore.FieldValue.increment(1)
    });

    localStorage.setItem(voteKey,"yes");
    loadRating();
  };
});

/* ===== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò ===== */
commentsRef.orderBy("created")
.onSnapshot(snapshot=>{
  const all = {};
  snapshot.forEach(doc=>{
    all[doc.id] = {id:doc.id, ...doc.data()}
  });

  document.getElementById("comments").innerHTML="";

  Object.values(all)
    .filter(c=>!c.parent)
    .forEach(c=>renderComment(c,all));
});

function renderComment(comment, all, parentDiv=null){
  const div = document.createElement("div");
  div.className = "comment";
  if(comment.parent) div.classList.add("reply");

  div.innerHTML = `
    <b>${comment.user}</b>
    <p>${comment.text}</p>
    <button onclick="like('${comment.id}')">
      üëç ${comment.likes || 0}
    </button>
    <button onclick="dislike('${comment.id}')">
      üëé ${comment.dislikes || 0}
    </button>
    <button onclick="openReply('${comment.id}')">
      –û—Ç–≤–µ—Ç–∏—Ç—å
    </button>
    ${currentUser===comment.user 
      ? `<button onclick="deleteComment('${comment.id}')">–£–¥–∞–ª–∏—Ç—å</button>`
      : ""}
  `;

  (parentDiv || document.getElementById("comments"))
    .appendChild(div);

  Object.values(all)
    .filter(c=>c.parent===comment.id)
    .forEach(child=>renderComment(child,all,div));
}

async function addComment(parent=null,text=null){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

  const value = text || document.getElementById("commentInput").value;
  if(!value) return;

  await commentsRef.add({
    user: currentUser,
    text: value,
    parent: parent||null,
    likes:0,
    dislikes:0,
    created:Date.now()
  });

  document.getElementById("commentInput").value="";
}

/* ===== LIKE / DISLIKE ===== */
async function like(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

  if(votingInProgress[id]) return;
  votingInProgress[id] = true;

  const voteDoc = votesRef.doc(currentUser+"_"+id);
  const voteSnap = await voteDoc.get();

  if(voteSnap.exists){
    const oldType = voteSnap.data().type;

    if(oldType === "like"){
      await commentsRef.doc(id).update({
        likes: firebase.firestore.FieldValue.increment(-1)
      });
      await voteDoc.delete();
      votingInProgress[id] = false;
      return;
    }

    if(oldType === "dislike"){
      await commentsRef.doc(id).update({
        dislikes: firebase.firestore.FieldValue.increment(-1),
        likes: firebase.firestore.FieldValue.increment(1)
      });
      await voteDoc.update({type:"like"});
      votingInProgress[id] = false;
      return;
    }
  }

  await commentsRef.doc(id).update({
    likes: firebase.firestore.FieldValue.increment(1)
  });

  await voteDoc.set({type:"like"});
  votingInProgress[id] = false;
}


async function dislike(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

  if(votingInProgress[id]) return;
  votingInProgress[id] = true;

  const voteDoc = votesRef.doc(currentUser+"_"+id);
  const voteSnap = await voteDoc.get();

  if(voteSnap.exists){
    const oldType = voteSnap.data().type;

    if(oldType === "dislike"){
      await commentsRef.doc(id).update({
        dislikes: firebase.firestore.FieldValue.increment(-1)
      });
      await voteDoc.delete();
      votingInProgress[id] = false;
      return;
    }

    if(oldType === "like"){
      await commentsRef.doc(id).update({
        likes: firebase.firestore.FieldValue.increment(-1),
        dislikes: firebase.firestore.FieldValue.increment(1)
      });
      await voteDoc.update({type:"dislike"});
      votingInProgress[id] = false;
      return;
    }
  }

  await commentsRef.doc(id).update({
    dislikes: firebase.firestore.FieldValue.increment(1)
  });

  await voteDoc.set({type:"dislike"});
  votingInProgress[id] = false;
}


/* ===== DELETE ===== */
async function deleteComment(id){
  const doc = await commentsRef.doc(id).get();
  if(!doc.exists) return;
  if(doc.data().user!==currentUser) 
      return alert("–ù–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");

  await commentsRef.doc(id).delete();
}

/* ===== REPLY ===== */
function openReply(id){
  replyTo = id;
  document.getElementById("modal").classList.remove("hidden");
}

function closeModal(){
  document.getElementById("modal").classList.add("hidden");
}

async function saveReply(){
  const text = document.getElementById("modalText").value;
  if(text) await addComment(replyTo,text);
  document.getElementById("modalText").value="";
  closeModal();
}

/* ===== –ê–í–¢–û–í–•–û–î ===== */
window.onload = async ()=>{
  const savedNick = localStorage.getItem("nickname");
  if(savedNick){
    currentUser = savedNick;
    console.log("–í–æ—à–ª–∏ –∫–∞–∫ "+currentUser);
  }
  loadRating();
  countView();
}
</script>

</body>
</html>
