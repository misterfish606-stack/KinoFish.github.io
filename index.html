<script>
const firebaseConfig = {
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c",
  storageBucket: "kino-project-bf21c.firebasestorage.app",
  messagingSenderId: "603398460201",
  appId: "1:603398460201:web:42612fab9d600222985d38"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = localStorage.getItem("currentUser") || null;
let replyParentId = null;

// ===================== –õ–û–ì–ò–ù =====================
function login(){
  const name = document.getElementById("loginName").value.trim();
  if(!name) return;
  currentUser = name;
  localStorage.setItem("currentUser", name);
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + name;
}

if(currentUser){
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser;
}

// ===================== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò =====================
document.getElementById("sendComment").addEventListener("click", async ()=>{
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

  const text = document.getElementById("commentInput").value.trim();
  if(!text) return;

  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes: 0,
    dislikes: 0,
    likedBy: [],
    dislikedBy: [],
    parentId: null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("commentInput").value="";
});

db.collection("comments").orderBy("timestamp","asc")
.onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";

  const all = {};
  snapshot.forEach(doc=>{
    all[doc.id] = {
      id: doc.id,
      ...doc.data(),
      replies:[]
    };
  });

  Object.values(all).forEach(c=>{
    if(c.parentId && all[c.parentId]){
      all[c.parentId].replies.push(c);
    }
  });

  Object.values(all)
    .filter(c=>!c.parentId)
    .forEach(c=>{
      container.appendChild(createComment(c,0));
    });
});

// ===================== –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø =====================
function createComment(c, level){
  const div = document.createElement("div");
  div.className="comment";
  div.style.marginLeft = (level*25)+"px";
  div.id="comment-"+c.id;

  div.innerHTML = `
    <b>${c.name}</b>: ${c.text}<br>
    <button onclick="likeComment('${c.id}')">üëç ${c.likes || 0}</button>
    <button onclick="dislikeComment('${c.id}')">üëé ${c.dislikes || 0}</button>
    <button onclick="replyComment('${c.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    ${c.name === currentUser ? `<button onclick="deleteComment('${c.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ``}
  `;

  if(c.replies.length){
    c.replies.forEach(r=>{
      div.appendChild(createComment(r, level+1));
    });
  }

  return div;
}

// ===================== –õ–ê–ô–ö / –î–ò–ó–õ–ê–ô–ö =====================
async function likeComment(id){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");

  const ref = db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;

    let likedBy = doc.data().likedBy || [];
    if(likedBy.includes(currentUser)) return;

    t.update(ref,{
      likes:(doc.data().likes || 0)+1,
      likedBy:[...likedBy, currentUser]
    });
  });
}

async function dislikeComment(id){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");

  const ref = db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;

    let dislikedBy = doc.data().dislikedBy || [];
    if(dislikedBy.includes(currentUser)) return;

    t.update(ref,{
      dislikes:(doc.data().dislikes || 0)+1,
      dislikedBy:[...dislikedBy, currentUser]
    });
  });
}

// ===================== –û–¢–í–ï–¢ =====================
function replyComment(parentId){
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

  replyParentId = parentId;
  document.getElementById("replyModal").style.display="flex";
}

function closeReply(){
  document.getElementById("replyModal").style.display="none";
  document.getElementById("replyText").value="";
  replyParentId=null;
}

async function sendReply(){
  const text = document.getElementById("replyText").value.trim();
  if(!text || !replyParentId) return;

  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes:0,
    dislikes:0,
    likedBy:[],
    dislikedBy:[],
    parentId: replyParentId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  closeReply();
}

// ===================== –£–î–ê–õ–ï–ù–ò–ï =====================
async function deleteComment(id){
  const snapshot = await db.collection("comments")
      .where("parentId","==",id)
      .get();

  for(const doc of snapshot.docs){
    await deleteComment(doc.id);
  }

  await db.collection("comments").doc(id).delete();
}

// ===================== –ü–†–û–°–ú–û–¢–†–´ =====================
let viewed = localStorage.getItem("viewedMovie1");

if(!viewed){
  let views = parseInt(localStorage.getItem("viewsMovie1")) || 0;
  views++;
  localStorage.setItem("viewsMovie1", views);
  localStorage.setItem("viewedMovie1", "true");
}

document.getElementById("viewCount").innerHTML =
"<b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> " + (localStorage.getItem("viewsMovie1") || 0);
</script>
