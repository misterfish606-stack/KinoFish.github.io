<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const movieId = "goodbadugly";

let currentUser = localStorage.getItem("currentUser") || null;
let replyParentId = null;

// ====================== –£–ù–ò–ö–ê–õ–¨–ù–û–ï –ò–ú–Ø ======================
async function login(){
  const name = document.getElementById("loginName").value.trim();
  if(!name) return;

  const userRef = db.collection("users").doc(name);
  const doc = await userRef.get();

  if(doc.exists){
    document.getElementById("currentUser").innerHTML =
      "<span style='color:red'>–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ</span>";
    return;
  }

  await userRef.set({created: Date.now()});

  currentUser = name;
  localStorage.setItem("currentUser", name);
  document.getElementById("currentUser").innerText =
    "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + name;
}

if(currentUser){
  document.getElementById("currentUser").innerText =
    "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser;
}

// ====================== –ü–†–û–°–ú–û–¢–†–´ ======================
async function addView(){
  if(localStorage.getItem("viewed_"+movieId)) return;

  const ref = db.collection("movies").doc(movieId);

  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    const views = doc.exists ? (doc.data().views || 0) : 0;
    t.set(ref,{views: views+1},{merge:true});
  });

  localStorage.setItem("viewed_"+movieId,"1");
}

db.collection("movies").doc(movieId)
.onSnapshot(doc=>{
  const views = doc.exists ? (doc.data().views || 0) : 0;
  document.getElementById("viewCount").innerHTML =
    "<b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> " + views;
});

addView();

// ====================== –†–ï–ô–¢–ò–ù–ì ======================
document.querySelectorAll(".star").forEach(star=>{
  star.addEventListener("click", async ()=>{
    if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

    const voteRef = db.collection("ratings")
      .doc(movieId+"_"+currentUser);

    const voteDoc = await voteRef.get();
    if(voteDoc.exists) return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

    const value = parseInt(star.dataset.value);

    await voteRef.set({value:value});

    const movieRef = db.collection("movies").doc(movieId);

    await db.runTransaction(async t=>{
      const doc = await t.get(movieRef);
      const data = doc.exists ? doc.data() : {};
      const total = data.totalRating || 0;
      const count = data.ratingCount || 0;

      t.set(movieRef,{
        totalRating: total + value,
        ratingCount: count + 1
      },{merge:true});
    });
  });
});

db.collection("movies").doc(movieId)
.onSnapshot(doc=>{
  if(!doc.exists) return;

  const total = doc.data().totalRating || 0;
  const count = doc.data().ratingCount || 0;
  const avg = count ? (total/count).toFixed(1) : "0.0";

  document.getElementById("avgRating").innerText =
    "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê" + avg;
  document.getElementById("votes").innerText =
    "(" + count + " –≥–æ–ª–æ—Å–æ–≤)";
});

// ====================== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò ======================
document.getElementById("sendComment")
.addEventListener("click", async ()=>{
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");

  const text = document.getElementById("commentInput").value.trim();
  if(!text) return;

  await db.collection("comments").add({
    movieId,
    name: currentUser,
    text,
    parentId: null,
    likes:0,
    dislikes:0,
    likedBy:[],
    dislikedBy:[],
    created: Date.now()
  });

  document.getElementById("commentInput").value="";
});

db.collection("comments")
.where("movieId","==",movieId)
.orderBy("created")
.onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";

  const all={};

  snapshot.forEach(doc=>{
    all[doc.id]={id:doc.id,...doc.data(),replies:[]};
  });

  Object.values(all).forEach(c=>{
    if(c.parentId && all[c.parentId])
      all[c.parentId].replies.push(c);
  });

  Object.values(all)
    .filter(c=>!c.parentId)
    .forEach(c=>{
      container.appendChild(createComment(c,0));
    });
});

function createComment(c,level){
  const div=document.createElement("div");
  div.className="comment";
  div.style.marginLeft=(level*20)+"px";

  let ownerButtons="";
  if(c.name===currentUser){
    ownerButtons=`
      <div style="position:absolute;top:5px;right:5px">
        <button onclick="editComment('${c.id}')">‚úè</button>
        <button style="background:red"
        onclick="deleteComment('${c.id}')">–£–¥–∞–ª–∏—Ç—å</button>
      </div>`;
  }

  div.innerHTML=`
    ${ownerButtons}
    <b>${c.name}</b>: ${c.text}<br>
    <button onclick="like('${c.id}')">üëç ${c.likes}</button>
    <button onclick="dislike('${c.id}')">üëé ${c.dislikes}</button>
    <button onclick="openReply('${c.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
  `;

  c.replies.forEach(r=>{
    div.appendChild(createComment(r,level+1));
  });

  return div;
}

// ====================== –õ–ê–ô–ö / –î–ò–ó–õ–ê–ô–ö ======================
async function like(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  const ref=db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let liked=doc.data().likedBy||[];
    if(liked.includes(currentUser)) return;

    t.update(ref,{
      likes:(doc.data().likes||0)+1,
      likedBy:[...liked,currentUser]
    });
  });
}

async function dislike(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  const ref=db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let arr=doc.data().dislikedBy||[];
    if(arr.includes(currentUser)) return;

    t.update(ref,{
      dislikes:(doc.data().dislikes||0)+1,
      dislikedBy:[...arr,currentUser]
    });
  });
}

// ====================== –û–¢–í–ï–¢ –ú–û–î–ê–õ–ö–ê ======================
function openReply(id){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
  replyParentId=id;
  document.getElementById("replyModal").style.display="flex";
}

function closeReply(){
  document.getElementById("replyModal").style.display="none";
  document.getElementById("replyText").value="";
}

async function sendReply(){
  const text=document.getElementById("replyText").value.trim();
  if(!text) return;

  await db.collection("comments").add({
    movieId,
    name:currentUser,
    text,
    parentId:replyParentId,
    likes:0,
    dislikes:0,
    likedBy:[],
    dislikedBy:[],
    created:Date.now()
  });

  closeReply();
}

// ====================== –£–î–ê–õ–ï–ù–ò–ï ======================
async function deleteComment(id){
  const snap=await db.collection("comments")
    .where("parentId","==",id).get();

  for(const d of snap.docs){
    await deleteComment(d.id);
  }

  await db.collection("comments").doc(id).delete();
}

async function editComment(id){
  const text=prompt("–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
  if(!text) return;
  await db.collection("comments").doc(id)
    .update({text});
}
</script>
