<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–•–æ—Ä–æ—à–∏–π –ü–ª–æ—Ö–æ–π –ó–ª–æ–π</title>
<style>
body{
margin:0;
font-family:Georgia, serif;
background:linear-gradient(to bottom,#3a2c1a,#1a1208);
color:#f5e6c4;
}

h2,h3{
color:#d4af37;
text-shadow:2px 2px 5px black;
}

button{
background:#5a3e1b;
color:white;
border:none;
padding:8px 12px;
border-radius:5px;
}

button:hover{
background:#8b5a2b;
}

.modal-box{
background:#222;
padding:30px;
border-radius:10px;
width:400px;
position:relative;
}
.close{
position:absolute;
right:10px;top:10px;
color:red;
cursor:pointer;
font-size:20px;
}
.error{color:red}
</style>
</head>
<body>

<div class="container">
<div class="poster">
<img src="https://upload.wikimedia.org/wikipedia/en/4/45/Good_the_bad_and_the_ugly_poster.jpg">
<h2>–•–æ—Ä–æ—à–∏–π –ü–ª–æ—Ö–æ–π –ó–ª–æ–π</h2>
</div>

<div class="info">
<h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

<p><b>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</b> 1966</p>

<p><b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b>
<a href="https://www.imdb.com/title/tt0060196/" target="_blank">
The Good, the Bad and the Ugly
</a></p>

<p><b>–°—Ç—Ä–∞–Ω–∞:</b> 
<a href="https://ru.wikipedia.org/wiki/–ò—Ç–∞–ª–∏—è" target="_blank">–ò—Ç–∞–ª–∏—è</a>, 
<a href="https://ru.wikipedia.org/wiki/–ò—Å–ø–∞–Ω–∏—è" target="_blank">–ò—Å–ø–∞–Ω–∏—è</a>
</p>

<p><b>–ñ–∞–Ω—Ä:</b> 
<a href="https://ru.wikipedia.org/wiki/–í–µ—Å—Ç–µ—Ä–Ω" target="_blank">
–í–µ—Å—Ç–µ—Ä–Ω
</a></p>

<p><b>–†–µ–∂–∏—Å—Å–µ—Ä:</b> 
<a href="https://ru.wikipedia.org/wiki/–õ–µ–æ–Ω–µ,_–°–µ—Ä–¥–∂–æ" target="_blank">
–°–µ—Ä–¥–∂–∏–æ –õ–µ–æ–Ω–µ
</a></p>

<p><b>–í –≥–ª–∞–≤–Ω—ã—Ö —Ä–æ–ª—è—Ö:</b><br>
<a href="https://ru.wikipedia.org/wiki/–ò—Å—Ç–≤—É–¥,_–ö–ª–∏–Ω—Ç" target="_blank">–ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥</a><br>
<a href="https://ru.wikipedia.org/wiki/–£–æ–ª–ª–∞—Ö,_–≠–ª–∏" target="_blank">–≠–ª–∏ –£–æ–ª–ª–∞—Ö</a><br>
<a href="https://ru.wikipedia.org/wiki/–í–∞–Ω_–ö–ª–∏—Ñ,_–õ–∏" target="_blank">–õ–∏ –í–∞–Ω –ö–ª–∏—Ñ</a>
</p>

<p><b>IMDb:</b> 
<a href="https://www.imdb.com/title/tt0060196/" target="_blank">
8.8 / 10
</a></p>

<p><b>–ö–∏–Ω–æ–ø–æ–∏—Å–∫:</b> 
<a href="https://www.kinopoisk.ru/film/349/" target="_blank">
8.5 / 10
</a></p>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<div id="comments"></div>
<textarea id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea><br>
<button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<div id="modal" class="modal hidden">
<div class="modal-box">
<span class="close" onclick="closeModal()">‚úñ</span>
<textarea id="modalText"></textarea><br><br>
<button onclick="saveEdit()">–û—Ç–≤–µ—Ç</button>
<button style="background:red;color:white" onclick="deleteComment()">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
authDomain: "kino-project-bf21c.firebaseapp.com",
projectId: "1:603398460201:web:ab3729a41f48e419985d38",
});

const db=firebase.firestore();
let currentUser=null;
let selectedComment=null;

/* LOGIN */
async function login(){
const nick=document.getElementById("nickname").value.trim();
if(!nick)return;

const snap=await db.collection("users").doc(nick).get();
if(snap.exists){
document.getElementById("loginError").innerText="–ù–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç";
return;
}

await db.collection("users").doc(nick).set({created:Date.now()});
currentUser=nick;
document.getElementById("loginError").innerText="";
alert("–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+nick);
}

/* VIEWS */
async function countView(){
if(!localStorage.getItem("viewed")){
await db.collection("stats").doc("views").set({
count:firebase.firestore.FieldValue.increment(1)
},{merge:true});
localStorage.setItem("viewed","yes");
}
const snap=await db.collection("stats").doc("views").get();
document.getElementById("views").innerText=snap.data()?.count||0;
}
countView();

/* RATING */
const ratingRef=db.collection("stats").doc("rating");

document.querySelectorAll(".stars span").forEach(star=>{
star.onclick=async()=>{
if(!currentUser)return alert("–í–æ–π–¥–∏—Ç–µ");
if(localStorage.getItem("rated"))return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

const val=parseInt(star.getAttribute("data"));
await ratingRef.set({
total:firebase.firestore.FieldValue.increment(val),
votes:firebase.firestore.FieldValue.increment(1)
},{merge:true});

localStorage.setItem("rated","yes");
loadRating();
};
});

async function loadRating(){
const snap=await ratingRef.get();
if(!snap.exists)return;
const data=snap.data();
const avg=(data.total/data.votes).toFixed(1);
document.getElementById("rating").innerText=avg;
}
loadRating();

/* COMMENTS */
function renderComment(doc,parent=null){
const data=doc.data();
const div=document.createElement("div");
div.className="comment";
if(parent)div.classList.add("reply");

div.innerHTML=`
<b>${data.user}</b>
<span class="menu" onclick="openMenu('${doc.id}')">‚ãÆ</span>
<p>${data.text}</p>
<button onclick="like('${doc.id}')">üëç ${data.likes||0}</button>
<button onclick="dislike('${doc.id}')">üëé ${data.dislikes||0}</button>
<button onclick="reply('${doc.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
`;

(parent||document.getElementById("comments")).appendChild(div);

db.collection("comments").where("parent","==",doc.id)
.onSnapshot(snap=>{
snap.forEach(d=>renderComment(d,div));
});
}

db.collection("comments").where("parent","==",null)
.onSnapshot(snap=>{
document.getElementById("comments").innerHTML="";
snap.forEach(doc=>renderComment(doc));
});

async function addComment(parent=null,text=null){
if(!currentUser)return alert("–í–æ–π–¥–∏—Ç–µ");
const value=text||document.getElementById("commentInput").value;
if(!value)return;

await db.collection("comments").add({
user:currentUser,
text:value,
parent:parent||null,
likes:0,
dislikes:0,
created:Date.now()
});
document.getElementById("commentInput").value="";
}

/* LIKE */
async function like(id){
if(!currentUser)return;
const voteRef=db.collection("votes").doc(currentUser+"_"+id);
const snap=await voteRef.get();
if(snap.exists)return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

await db.collection("comments").doc(id).update({
likes:firebase.firestore.FieldValue.increment(1)
});
await voteRef.set({type:"like"});
}

/* DISLIKE */
async function dislike(id){
if(!currentUser)return;
const voteRef=db.collection("votes").doc(currentUser+"_"+id);
const snap=await voteRef.get();
if(snap.exists)return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

await db.collection("comments").doc(id).update({
dislikes:firebase.firestore.FieldValue.increment(1)
});
await voteRef.set({type:"dislike"});
}

/* REPLY */
function reply(id){
selectedComment=id;
document.getElementById("modal").classList.remove("hidden");
}

function closeModal(){
document.getElementById("modal").classList.add("hidden");
}

async function saveEdit(){
const text=document.getElementById("modalText").value;
if(text)await addComment(selectedComment,text);
closeModal();
}

/* DELETE */
async function deleteComment(){
if(!selectedComment)return;
const doc=await db.collection("comments").doc(selectedComment).get();
if(doc.data().user!==currentUser)return alert("–ù–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");

await db.collection("comments").doc(selectedComment).delete();
closeModal();
}
</script>
</body>
</html>

