<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</title>
<style>
body{margin:0;font-family:'Arial Black',sans-serif;background:#1b0000;color:#eee;overflow-x:hidden;}
.wrapper{width:70%;margin:0 auto;padding-bottom:60px;}
body::after{content:"";position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;background-image:radial-gradient(2px 2px at 20px 30px, rgba(255,220,180,0.4), transparent),radial-gradient(2px 2px at 100px 80px, rgba(255,220,180,0.4), transparent),radial-gradient(2px 2px at 200px 150px, rgba(255,220,180,0.4), transparent),radial-gradient(2px 2px at 300px 50px, rgba(255,220,180,0.4), transparent);background-repeat:repeat;background-size:400px 400px;animation:dust 20s linear infinite;}
@keyframes dust{from{transform:translateY(0);} to{transform:translateY(-400px);}}
.slider{position:relative;margin-top:20px;overflow:hidden;border-radius:10px;height:200px;background:#220000;padding:10px;box-shadow:0 0 15px #900;}
.slides{display:flex;transition:0.5s;}
.slides img{width:300px;margin-right:15px;border-radius:5px;cursor:pointer;transition:0.3s;}
.slides img:hover{transform:scale(1.05);}
.prev,.next{position:absolute;top:50%;transform:translateY(-50%);background:#330000;border:none;color:white;font-size:20px;padding:8px;cursor:pointer;border-radius:5px;}
.prev{left:5px;} .next{right:5px;}
.top{display:flex;gap:30px;margin-top:30px;}
.poster img{width:250px;border-radius:10px;box-shadow:0 0 20px #900;}
.info-block{display:flex;flex-direction:column;justify-content:flex-start;}
.description{margin-top:30px;line-height:1.6;padding:15px;background:#220000;border-radius:10px;box-shadow:0 0 15px #900;}
.video-container{margin-top:30px;}
.video-container iframe{width:100%;height:500px;border-radius:10px;box-shadow:0 0 25px #900;}
button{padding:6px 10px;background:#330000;color:white;border:1px solid #aa0000;border-radius:5px;cursor:pointer;margin-top:5px;}
button:hover{background:#660000;}
.star{font-size:24px;color:#550000;cursor:pointer;}
.star.selected{color:gold;}
#avgRating{font-size:18px;color:gold;margin-top:10px;}
.comment{background:#140000;padding:10px;margin-top:10px;border-left:4px solid #aa0000;border-radius:5px;}
</style>
</head>
<body>
<div class="wrapper">
<h2>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</h2>

  <style>
.comment{
  background:#1c1c1c;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
  position:relative;
}

.menu{
  position:absolute;
  right:10px;
  top:10px;
  cursor:pointer;
}

.dropdown{
  display:none;
  position:absolute;
  right:10px;
  top:30px;
  background:#333;
  padding:5px;
  border-radius:5px;
}

.reply-btn{
  margin-top:10px;
}

.replies{
  margin-left:30px;
  margin-top:10px;
  border-left:2px solid #333;
  padding-left:10px;
}

.modal{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:black;
  padding:20px;
  width:400px;
  display:none;
  border-radius:10px;
  z-index:1000;
}

.modal textarea{
  width:100%;
  height:80px;
  margin-bottom:10px;
}
</style>

<div class="modal" id="replyModal">
  <textarea id="replyText" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç..."></textarea>
  <div style="display:flex; justify-content:space-between;">
    <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    <div>
      <button onclick="closeModal()">–í—ã—Ö–æ–¥</button>
      <button onclick="sendReply()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>

// ===== –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø =====
let userId = localStorage.getItem("userId");
if(!userId){
  userId = "user_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

// ===== –ü–†–û–°–ú–û–¢–†–´ (1 —Ä–∞–∑) =====
if(!localStorage.getItem("viewed")){
  db.collection("stats").doc("views").set({
    count: firebase.firestore.FieldValue.increment(1)
  },{merge:true});
  localStorage.setItem("viewed","yes");
}

// ===== –†–ï–ù–î–ï–† –ö–û–ú–ú–ï–ù–¢–û–í =====
db.collection("comments").orderBy("timestamp","desc")
.onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";
  snapshot.forEach(doc=>{
    renderComment(doc, container);
  });
});

function renderComment(doc, container){
  const c = doc.data();
  const div = document.createElement("div");
  div.className="comment";

  div.innerHTML=`
    <div class="menu" onclick="toggleMenu('${doc.id}')">‚ãÆ</div>
    <div class="dropdown" id="menu-${doc.id}">
      ${c.userId===userId ? `<button onclick="deleteComment('${doc.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ``}
    </div>
    <b>${c.name}</b>: ${c.text}
    <br>
    <button onclick="like('${doc.id}','likes')">üëç ${c.likes||0}</button>
    <button onclick="like('${doc.id}','dislikes')">üëé ${c.dislikes||0}</button>
    <br>
    <button class="reply-btn" onclick="openReply('${doc.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    <div class="replies" id="replies-${doc.id}"></div>
  `;

  container.appendChild(div);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç—ã
  db.collection("comments")
    .doc(doc.id)
    .collection("replies")
    .orderBy("timestamp","asc")
    .onSnapshot(snap=>{
      const repliesDiv = document.getElementById("replies-"+doc.id);
      repliesDiv.innerHTML="";
      snap.forEach(r=>{
        renderReply(doc.id, r, repliesDiv);
      });
    });
}

function renderReply(parentId, replyDoc, container){
  const r = replyDoc.data();
  const div = document.createElement("div");
  div.className="comment";

  div.innerHTML=`
    <div class="menu" onclick="toggleMenu('r${replyDoc.id}')">‚ãÆ</div>
    <div class="dropdown" id="menur${replyDoc.id}">
      ${r.userId===userId ? `<button onclick="deleteReply('${parentId}','${replyDoc.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ``}
    </div>
    <b>${r.name}</b>: ${r.text}
    <br>
    <button onclick="likeReply('${parentId}','${replyDoc.id}','likes')">üëç ${r.likes||0}</button>
    <button onclick="likeReply('${parentId}','${replyDoc.id}','dislikes')">üëé ${r.dislikes||0}</button>
    <br>
    <button onclick="openReply('${parentId}','${replyDoc.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
  `;

  container.appendChild(div);
}

// ===== –õ–ê–ô–ö 1 –†–ê–ó =====
async function like(id,field){
  const voteKey = id+"_"+field;
  if(localStorage.getItem(voteKey)) return;

  const ref = db.collection("comments").doc(id);
  await ref.update({
    [field]: firebase.firestore.FieldValue.increment(1)
  });

  localStorage.setItem(voteKey,"yes");
}

async function likeReply(parentId,id,field){
  const voteKey = parentId+"_"+id+"_"+field;
  if(localStorage.getItem(voteKey)) return;

  const ref = db.collection("comments")
    .doc(parentId)
    .collection("replies")
    .doc(id);

  await ref.update({
    [field]: firebase.firestore.FieldValue.increment(1)
  });

  localStorage.setItem(voteKey,"yes");
}

// ===== –£–î–ê–õ–ï–ù–ò–ï =====
function deleteComment(id){
  db.collection("comments").doc(id).delete();
}
function deleteReply(parentId,id){
  db.collection("comments")
    .doc(parentId)
    .collection("replies")
    .doc(id)
    .delete();
}

// ===== –ú–û–î–ê–õ–ö–ê =====
let currentReplyParent=null;

function openReply(parentId){
  currentReplyParent=parentId;
  document.getElementById("replyModal").style.display="block";
}

function closeModal(){
  document.getElementById("replyModal").style.display="none";
  document.getElementById("replyText").value="";
}

function sendReply(){
  const text=document.getElementById("replyText").value;
  if(!text) return;

  db.collection("comments")
    .doc(currentReplyParent)
    .collection("replies")
    .add({
      name:"–í—ã",
      text:text,
      userId:userId,
      likes:0,
      dislikes:0,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });

  closeModal();
}

// ===== –ú–ï–ù–Æ =====
function toggleMenu(id){
  const el=document.getElementById("menu-"+id) || document.getElementById("menu"+id);
  if(el) el.style.display = el.style.display==="block" ? "none":"block";
}

</script>

<!-- –°–ª–∞–π–¥–µ—Ä -->
<div class="slider">
  <div class="slides" id="slides">
    <img src="https://upload.wikimedia.org/wikipedia/en/4/45/Good_the_bad_and_the_ugly_poster.jpg">
    <img src="https://m.media-amazon.com/images/I/91z+4nW6zRL._AC_SL1500_.jpg">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/The_Good_the_Bad_and_the_Ugly.jpg">
  </div>
  <button class="prev" onclick="moveSlide(-1)">‚ùÆ</button>
  <button class="next" onclick="moveSlide(1)">‚ùØ</button>
</div>

<!-- –ò–Ω—Ñ–æ -->
<div class="top">
  <div class="poster"><img src="https://i.imgur.com/XKxOxxg.jpg"></div>
  <div class="info-block">
    <p><b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b> The Good, the Bad and the Ugly</p>
    <p><b>–°—Ç—Ä–∞–Ω—ã:</b> –ò—Ç–∞–ª–∏—è, –ò—Å–ø–∞–Ω–∏—è</p>
    <p><b>–ñ–∞–Ω—Ä:</b> –í–µ—Å—Ç–µ—Ä–Ω / –≠–∫—à–Ω</p>
    <p><b>–†–µ–π—Ç–∏–Ω–≥ –ö–∏–Ω–æ–ü–æ–∏—Å–∫:</b> 8.6</p>
    <p><b>–†–µ–π—Ç–∏–Ω–≥ IMDb:</b> 8.8</p>
    <p><b>–†–µ–∂–∏—Å—Å—ë—Ä:</b> –°–µ—Ä–¥–∂–æ –õ–µ–æ–Ω–µ</p>
    <p><b>–ê–∫—Ç—ë—Ä—ã:</b> –ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥, –õ–∏ –í–∞–Ω –ö–ª–∏—Ñ, –ò–ª–∞–π –£–æ–ª–ª–∞–∫</p>
    <p id="viewCount"><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> 0</p>
    <div id="avgRating">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê0.0</div>
    <div>
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
      <span id="votes">(0 –≥–æ–ª–æ—Å–æ–≤)</span>
    </div>
  </div>
</div>

<div class="description">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä—ë—Ö –æ—Ö–æ—Ç–Ω–∏–∫–æ–≤ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∞ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –≤–æ–π–Ω—ã –≤ –°–®–ê.</div>

<div class="video-container">
  <iframe id="movie" src="https://www.youtube.com/embed/0Bwxz16-T04?enablejsapi=1" allowfullscreen></iframe>
</div>

<h3>–í—Ö–æ–¥</h3>
<input type="text" id="loginName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
<button onclick="login()">–í–æ–π—Ç–∏</button>
<p id="currentUser"></p>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<input type="text" id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button id="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<div id="commentList"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c",
  storageBucket: "kino-project-bf21c.firebasestorage.app",
  messagingSenderId: "603398460201",
  appId: "1:603398460201:web:42612fab9d600222985d38"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
let currentUser = localStorage.getItem("currentUser") || null;
function login(){
  const name = document.getElementById("loginName").value.trim();
  if(!name) return;
  currentUser = name;
  localStorage.setItem("currentUser", name);
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + name;
}
if(currentUser) document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser;

// –ü—Ä–æ—Å–º–æ—Ç—Ä—ã
const viewRef = db.collection("stats").doc("views");
viewRef.get().then(doc=>{
  if(!doc.exists){ viewRef.set({count:0}); } 
  else { document.getElementById("viewCount").innerText = "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: " + (doc.data().count+1);}
  viewRef.update({count: firebase.firestore.FieldValue.increment(1)});
});

// –†–µ–π—Ç–∏–Ω–≥
const ratingRef = db.collection("stats").doc("rating");
function loadRating(){
  ratingRef.get().then(doc=>{
    if(!doc.exists){ ratingRef.set({totalScore:0,totalVotes:0}); return;}
    const data = doc.data();
    const avg = data.totalVotes ? (data.totalScore/data.totalVotes).toFixed(1) : "0.0";
    document.getElementById("avgRating").innerText = "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê" + avg;
    document.getElementById("votes").innerText = `(${data.totalVotes} –≥–æ–ª–æ—Å–æ–≤)`;
  });
}
loadRating();
document.querySelectorAll(".star").forEach(star=>{
  star.addEventListener("click",()=>{
    if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è!"); return;}
    const val = parseInt(star.getAttribute("data-value"));
    ratingRef.update({
      totalScore: firebase.firestore.FieldValue.increment(val),
      totalVotes: firebase.firestore.FieldValue.increment(1)
    }).then(loadRating);
  });
});

// –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
document.getElementById("sendComment").addEventListener("click", async ()=>{
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }
  const text = document.getElementById("commentInput").value.trim();
  if(!text) return;
  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes:0,
    dislikes:0,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getEl
    ementById("commentInput").value="";
});

db.collection("comments").orderBy("timestamp","desc").onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";
  snapshot.forEach(doc=>{
    const c = doc.data();
    const div = document.createElement("div");
    div.className="comment";
    div.innerHTML=`<b>${c.name}</b>: ${c.text}<br>
      <button onclick="likeComment('${doc.id}')">üëç ${c.likes || 0}</button>
      <button onclick="dislikeComment('${doc.id}')">üëé ${c.dislikes || 0}</button>`;
    container.appendChild(div);
  });
});

async function likeComment(id){
  const ref = db.collection("comments").doc(id);
  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;
    t.update(ref,{likes:(doc.data().likes||0)+1});
  });
}
async function dislikeComment(id){
  const ref = db.collection("comments").doc(id);
  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;
    t.update(ref,{dislikes:(doc.data().dislikes||0)+1});
  });
}

// –°–ª–∞–π–¥–µ—Ä
let index=0;
function moveSlide(step){
  const slides = document.getElementById("slides");
  const total = slides.children.length;
  const width = slides.children[0].offsetWidth + 15;
  index+=step;
  if(index<0) index=total-1;
  if(index>=total) index=0;
  slides.style.transform="translateX(-"+index*width+"px)";
}
</script>
</div>
</body>
</html>
