<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π</title>

<style>
body{
margin:0;
font-family:Georgia, serif;
background:linear-gradient(to bottom,#3a2c1a,#1a1208);
color:#f5e6c4;
}

.container{
display:flex;
gap:40px;
padding:40px;
}

.poster img{
width:300px;
border:5px solid #d4af37;
box-shadow:0 0 20px black;
}

h2,h3{
color:#d4af37;
text-shadow:2px 2px 5px black;
}

a{color:#ffd700;text-decoration:none}
a:hover{text-decoration:underline}

.info{max-width:700px}

textarea{
width:100%;
padding:10px;
margin-top:10px;
background:#2c1c0e;
color:white;
border:1px solid #d4af37;
}

button{
background:#5a3e1b;
color:white;
border:none;
padding:8px 14px;
margin-top:8px;
cursor:pointer;
}

button:hover{background:#8b5a2b}

.comment{
background:#2c1c0e;
padding:10px;
margin-top:10px;
border-left:3px solid #d4af37;
}

.reply{
margin-left:30px;
border-left:3px solid #aaa;
}

.modal{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.85);
display:flex;
justify-content:center;
align-items:center;
}

.hidden{display:none;}

.modal-box{
background:#1b1b1b;
padding:30px;
width:400px;
position:relative;
border:2px solid #d4af37;
}

.close{
position:absolute;
right:10px;
top:10px;
cursor:pointer;
color:red;
font-size:20px;
}

.stars span{
font-size:25px;
cursor:pointer;
color:#999;
}

.stars span:hover{
color:gold;
}
</style>
</head>
<body>

<div class="container">

<div class="poster">
<img src="https://upload.wikimedia.org/wikipedia/en/4/45/Good_the_bad_and_the_ugly_poster.jpg">
<h2>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π</h2>
</div>

<div class="info">
<p><b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b> <a href="https://www.imdb.com/title/tt0060196/" target="_blank"> The Good, the Bad and the Ugly </a> </p>
</p> <p><b>–°—Ç—Ä–∞–Ω–∞:</b> <a href="https://ru.wikipedia.org/wiki/–ò—Ç–∞–ª–∏—è" target="_blank">–ò—Ç–∞–ª–∏—è</a>, <a href="https://ru.wikipedia.org/wiki/–ò—Å–ø–∞–Ω–∏—è" target="_blank">–ò—Å–ø–∞–Ω–∏—è</a> </p> 
<p><b>–ñ–∞–Ω—Ä:</b> <a href="https://ru.wikipedia.org/wiki/–í–µ—Å—Ç–µ—Ä–Ω" target="_blank"> –í–µ—Å—Ç–µ—Ä–Ω </a></p> 
<p><b>–†–µ–∂–∏—Å—Å–µ—Ä:</b> <a href="https://ru.wikipedia.org/wiki/–õ–µ–æ–Ω–µ,_–°–µ—Ä–¥–∂–æ" target="_blank"> –°–µ—Ä–¥–∂–∏–æ –õ–µ–æ–Ω–µ </a></p>
<p><b>–í –≥–ª–∞–≤–Ω—ã—Ö —Ä–æ–ª—è—Ö:</b><br> <a href="https://ru.wikipedia.org/wiki/–ò—Å—Ç–≤—É–¥,_–ö–ª–∏–Ω—Ç" target="_blank">–ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥</a><br> <a href="https://ru.wikipedia.org/wiki/–£–æ–ª–ª–∞—Ö,_–≠–ª–∏" target="_blank">–≠–ª–∏ –£–æ–ª–ª–∞—Ö</a><br> <a href="https://ru.wikipedia.org/wiki/–í–∞–Ω_–ö–ª–∏—Ñ,_–õ–∏" target="_blank">–õ–∏ –í–∞–Ω –ö–ª–∏—Ñ</a> </p>
<p><b>–ì–æ–¥:</b> 1966</p>
<p><b>IMDb:</b> 8.8</p>
<p><b>–ö–∏–Ω–æ–ø–æ–∏—Å–∫:</b> 8.5</p>
<p><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Å–∞–π—Ç–∞:</b> <span id="views">0</span></p>

<h3>–§–∏–ª—å–º</h3>
<iframe width="560" height="315"
src="https://www.youtube.com/embed/KBFoXtncTfE"
allowfullscreen></iframe>

<h3>–û—Ü–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å–º</h3>
<div class="stars">
<span data="1">‚òÖ</span>
<span data="2">‚òÖ</span>
<span data="3">‚òÖ</span>
<span data="4">‚òÖ</span>
<span data="5">‚òÖ</span>
</div>
–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: <span id="rating">0</span>

<h3>–í—Ö–æ–¥</h3>
<input id="nickname" placeholder="–í–∞—à –Ω–∏–∫">
<button onclick="login()">–í–æ–π—Ç–∏</button>
<span id="loginError" style="color:red"></span>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<div id="comments"></div>

<textarea id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
<button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

</div>
</div>

<div id="modal" class="modal hidden">
<div class="modal-box">
<span class="close" onclick="closeModal()">‚úñ</span>
<textarea id="modalText"></textarea>
<button onclick="saveReply()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
authDomain: "kino-project-bf21c.firebaseapp.com",
projectId: "kino-project-bf21c"
});

const db=firebase.firestore();
let currentUser=null;
let replyTo=null;

/* LOGIN */
function login(){
const nick=document.getElementById("nickname").value.trim();
if(!nick)return;
currentUser=nick;
alert("–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+nick);
}

/* VIEWS */
async function countView(){
if(!localStorage.getItem("viewed")){
await db.collection("stats").doc("views").set({
count:firebase.firestore.FieldValue.increment(1)
},{merge:true});
localStorage.setItem("viewed","yes");
}
const snap=await db.collection("stats").doc("views").get();
document.getElementById("views").innerText=snap.data()?.count||0;
}
countView();

/* RATING */
const ratingRef=db.collection("stats").doc("rating");

document.querySelectorAll(".stars span").forEach(star=>{
star.onclick=async()=>{
if(!currentUser)return alert("–í–æ–π–¥–∏—Ç–µ");
if(localStorage.getItem("rated"))return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

const val=parseInt(star.getAttribute("data"));
await ratingRef.set({
total:firebase.firestore.FieldValue.increment(val),
votes:firebase.firestore.FieldValue.increment(1)
},{merge:true});

localStorage.setItem("rated","yes");
loadRating();
};
});

async function loadRating(){
const snap=await ratingRef.get();
if(!snap.exists)return;
const data=snap.data();
const avg=(data.total/data.votes).toFixed(1);
document.getElementById("rating").innerText=avg;
}
loadRating();

/* COMMENTS */
function renderComment(doc,parent=null){
const data=doc.data();
const div=document.createElement("div");
div.className="comment";
if(parent)div.classList.add("reply");

div.innerHTML=`
<b>${data.user}</b>
<p>${data.text}</p>
<button onclick="like('${doc.id}')">üëç ${data.likes||0}</button>
<button onclick="dislike('${doc.id}')">üëé ${data.dislikes||0}</button>
<button onclick="openReply('${doc.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
`;

(parent||document.getElementById("comments")).appendChild(div);

db.collection("comments")
.where("parent","==",doc.id)
.onSnapshot(snap=>{
snap.forEach(d=>renderComment(d,div));
});
}

db.collection("comments")
.where("parent","==",null)
.onSnapshot(snap=>{
document.getElementById("comments").innerHTML="";
snap.forEach(doc=>renderComment(doc));
});

async function addComment(parent=null,text=null){
if(!currentUser)return alert("–í–æ–π–¥–∏—Ç–µ");
const value=text||document.getElementById("commentInput").value;
if(!value)return;

await db.collection("comments").add({
user:currentUser,
text:value,
parent:parent||null,
likes:0,
dislikes:0,
created:Date.now()
});
document.getElementById("commentInput").value="";
}

/* LIKE */
async function like(id){
if(!currentUser)return;
const voteRef=db.collection("votes").doc(currentUser+"_"+id);
const snap=await voteRef.get();
if(snap.exists)return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

await db.collection("comments").doc(id).update({
likes:firebase.firestore.FieldValue.increment(1)
});
await voteRef.set({type:"like"});
}

/* DISLIKE */
async function dislike(id){
if(!currentUser)return;
const voteRef=db.collection("votes").doc(currentUser+"_"+id);
const snap=await voteRef.get();
if(snap.exists)return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏");

await db.collection("comments").doc(id).update({
dislikes:firebase.firestore.FieldValue.increment(1)
});
await voteRef.set({type:"dislike"});
}

/* MODAL */
function openReply(id){
replyTo=id;
document.getElementById("modal").classList.remove("hidden");
}

function closeModal(){
document.getElementById("modal").classList.add("hidden");
}

async function saveReply(){
const text=document.getElementById("modalText").value;
if(text)await addComment(replyTo,text);
document.getElementById("modalText").value="";
closeModal();
}
</script>

</body>
</html>
