<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</title>

<style>
body{margin:0;font-family:'Arial Black',sans-serif;background:#1b0000;color:#eee;overflow-x:hidden;}
.wrapper{width:70%;margin:0 auto;padding-bottom:60px;}
.comment{background:#140000;padding:10px;margin-top:10px;border-left:4px solid #aa0000;border-radius:5px;position:relative;}
.reply{margin-left:40px;background:#1f0000;border-left:4px solid #ff4444;}
.comment-buttons{position:absolute;top:5px;right:5px;}
button{padding:5px 8px;background:#330000;color:white;border:1px solid #aa0000;border-radius:5px;cursor:pointer;margin-top:5px;font-size:12px;}
button:hover{background:#660000;}
.video-container iframe{width:100%;height:500px;border-radius:10px;box-shadow:0 0 25px #900;margin-top:20px;}
</style>
</head>
<body>
<div class="wrapper">

<h2>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</h2>

<div class="video-container">
  <iframe src="https://www.youtube.com/embed/0Bwxz16-T04" allowfullscreen></iframe>
</div>

<p id="viewCount"><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> 0</p>

<h3>–í—Ö–æ–¥</h3>
<input type="text" id="loginName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
<button onclick="login()">–í–æ–π—Ç–∏</button>
<p id="currentUser"></p>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<input type="text" id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button id="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<div id="commentList"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
let currentUser = localStorage.getItem("currentUser") || null;
function login(){
  const name = document.getElementById("loginName").value.trim();
  if(!name) return;
  currentUser = name;
  localStorage.setItem("currentUser", name);
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + name;
}
if(currentUser){
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser;
}

// ===================== –ü—Ä–æ—Å–º–æ—Ç—Ä—ã (—Å–±–∏—Ç—ã –¥–æ 0) =====================
localStorage.setItem("views", 0);
document.getElementById("viewCount").innerHTML = "<b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> 0";

// ===================== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è =====================
document.getElementById("sendComment").addEventListener("click", async ()=>{
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }
  const text = document.getElementById("commentInput").value.trim();
  if(!text) return;
  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes:0,
    dislikes:0,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("commentInput").value="";
});

// ===================== –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ =====================
db.collection("comments").orderBy("timestamp","desc")
.onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";

  snapshot.forEach(doc=>{
    const c = doc.data();
    const div = document.createElement("div");
    div.className="comment";

    let buttonsHTML='';
    if(c.name===currentUser){
      buttonsHTML=`<div class="comment-buttons"><button onclick="deleteComment('${doc.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>`;
    } else {
      buttonsHTML=`<div class="comment-buttons"><button onclick="replyToComment('${doc.id}','${c.name}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button></div>`;
    }

    div.innerHTML=`<b>${c.name}</b>: ${c.text}<br>
      <button onclick="likeComment('${doc.id}')">üëç ${c.likes||0}</button>
      <button onclick="dislikeComment('${doc.id}')">üëé ${c.dislikes||0}</button>
      ${buttonsHTML}
      <div id="replies-${doc.id}"></div>`;

    container.appendChild(div);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç—ã
    db.collection("comments").doc(doc.id).collection("replies")
    .orderBy("timestamp")
    .onSnapshot(replySnap=>{
      const repliesDiv = document.getElementById(`replies-${doc.id}`);
      repliesDiv.innerHTML="";
      replySnap.forEach(replyDoc=>{
        const r = replyDoc.data();
        const replyEl = document.createElement("div");
        replyEl.className="comment reply";
        replyEl.innerHTML=`<b>${r.name}</b>: ${r.text}`;
        repliesDiv.appendChild(replyEl);
      });
    });
  });
});

// ===================== –û—Ç–≤–µ—Ç =====================
function replyToComment(id,name){
  const text = prompt(`–û—Ç–≤–µ—Ç –¥–ª—è ${name}:`);
  if(!text || !currentUser) return;

  db.collection("comments").doc(id).collection("replies").add({
    name: currentUser,
    text: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫–æ–º–º–µ–Ω—Ç—É
  document.querySelector(`[onclick*="${id}"]`).scrollIntoView({behavior:"smooth"});
}

// ===================== –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤–º–µ—Å—Ç–µ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ =====================
async function deleteComment(id){
  const replies = await db.collection("comments").doc(id).collection("replies").get();
  replies.forEach(async r=>{
    await r.ref.delete();
  });
  await db.collection("comments").doc(id).delete();
}

// ===================== –õ–∞–π–∫–∏ =====================
async function likeComment(id){
  const ref = db.collection("comments").doc(id);
  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;
    t.update(ref,{likes:(doc.data().likes||0)+1});
  });
}
async function dislikeComment(id){
  const ref = db.collection("comments").doc(id);
  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;
    t.update(ref,{dislikes:(doc.data().dislikes||0)+1});
  });
}

</script>
</div>
</body>
</html>
