<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</title>

<style>
  .reply-modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.reply-box{
  background:#220000;
  padding:20px;
  width:400px;
  border-radius:10px;
  box-shadow:0 0 25px #aa0000;
  display:flex;
  flex-direction:column;
}

.reply-box h3{
  text-align:center;
  margin-bottom:15px;
}

.reply-box textarea{
  resize:none;
  height:100px;
  margin-bottom:15px;
  padding:10px;
  border-radius:5px;
  border:none;
}

.reply-buttons{
  display:flex;
  justify-content:flex-start;
  gap:10px;
}

body{margin:0;font-family:'Arial Black',sans-serif;background:#1b0000;color:#eee;overflow-x:hidden;}
.wrapper{width:70%;margin:0 auto;padding-bottom:60px;}

/* –°–ª–∞–π–¥–µ—Ä */
.slider{position:relative;margin-top:20px;overflow:hidden;border-radius:10px;height:200px;background:#220000;padding:10px;box-shadow:0 0 15px #900;}
.slides{display:flex;transition:0.5s;}
.slides img{width:300px;margin-right:15px;border-radius:5px;cursor:pointer;transition:0.3s;}
.slides img:hover{transform:scale(1.05);}
.prev,.next{position:absolute;top:50%;transform:translateY(-50%);background:#330000;border:none;color:white;font-size:20px;padding:8px;cursor:pointer;border-radius:5px;}
.prev{left:5px;} .next{right:5px;}

/* –ò–Ω—Ñ–æ */
.top{display:flex;gap:30px;margin-top:30px;}
.poster img{width:250px;border-radius:10px;box-shadow:0 0 20px #900;}
.info-block{display:flex;flex-direction:column;justify-content:flex-start;}
.description{margin-top:30px;line-height:1.6;padding:15px;background:#220000;border-radius:10px;box-shadow:0 0 15px #900;}

/* –í–∏–¥–µ–æ */
.video-container{margin-top:30px;}
.video-container iframe{width:100%;height:500px;border-radius:10px;box-shadow:0 0 25px #900;}

/* –ö–Ω–æ–ø–∫–∏ */
button{padding:6px 10px;background:#330000;color:white;border:1px solid #aa0000;border-radius:5px;cursor:pointer;margin-top:5px;}
button:hover{background:#660000;}

/* –†–µ–π—Ç–∏–Ω–≥ */
.star{font-size:24px;color:#550000;cursor:pointer;}
.star.selected{color:gold;}
#avgRating{font-size:18px;color:gold;margin-top:10px;}

/* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
.comment{background:#140000;padding:10px;margin-top:10px;border-left:4px solid #aa0000;border-radius:5px;position:relative;}
.comment-buttons{position:absolute;top:5px;right:5px;}
.comment-buttons button{margin-left:5px;padding:2px 5px;font-size:12px;}
</style>
</head> 
  <div id="replyModal" class="reply-modal">
  <div class="reply-box">
    <h3>–í–∞—à –æ—Ç–≤–µ—Ç</h3>
    <textarea id="replyText" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
    <div class="reply-buttons">
      <button onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="closeReply()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<body>
<div class="wrapper">

<h2>–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π (1966)</h2>

<!-- –°–ª–∞–π–¥–µ—Ä -->
<div class="slider">
  <div class="slides" id="slides">
    <img src="https://raw.githubusercontent.com/fish606/kinofish/—Ö–æ—Ä–æ—à–∏–π/images/good.thm%20—Ö–æ—Ä–æ—à–∏–π.jpg" alt="–•–æ—Ä–æ—à–∏–π">
    <img src="https://raw.githubusercontent.com/fish606/kinofish/main/images/–∑–ª–æ–π.jpg" alt="–ó–ª–æ–π">
    <img src="https://raw.githubusercontent.com/fish606/kinofish/main/images/–ø–ª–æ—Ö–æ–π.jpg" alt="–ü–ª–æ—Ö–æ–π">
  </div>
  <button class="prev" onclick="moveSlide(-1)">‚ùÆ</button>
  <button class="next" onclick="moveSlide(1)">‚ùØ</button>
</div>

<script>
// ===================== –°–ª–∞–π–¥–µ—Ä =====================
let index = 0;
function moveSlide(step){
  const slides = document.getElementById("slides");
  const total = slides.children.length;
  const width = slides.children[0].offsetWidth + 15;
  index += step;
  if(index < 0) index = total - 1;
  if(index >= total) index = 0;
  slides.style.transform = "translateX(-"+index*width+"px)";
}
</script>

<!-- –ò–Ω—Ñ–æ -->
<div class="top">
  <div class="poster">
    <img src="https://i.imgur.com/XKxOxxg.jpg">
  </div>
  <div class="info-block">
    <p><b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b> The Good, the Bad and the Ugly</p>
    <p><b>–°—Ç—Ä–∞–Ω—ã:</b> –ò—Ç–∞–ª–∏—è, –ò—Å–ø–∞–Ω–∏—è</p>
    <p><b>–ñ–∞–Ω—Ä:</b> –í–µ—Å—Ç–µ—Ä–Ω / –≠–∫—à–Ω</p>
    <p><b>–†–µ–π—Ç–∏–Ω–≥ –ö–∏–Ω–æ–ü–æ–∏—Å–∫:</b> 8.6</p>
    <p><b>–†–µ–π—Ç–∏–Ω–≥ IMDb:</b> 8.8</p>
    <p><b>–†–µ–∂–∏—Å—Å—ë—Ä:</b> –°–µ—Ä–¥–∂–æ –õ–µ–æ–Ω–µ</p>
    <p><b>–ê–∫—Ç—ë—Ä—ã:</b> –ö–ª–∏–Ω—Ç –ò—Å—Ç–≤—É–¥, –õ–∏ –í–∞–Ω –ö–ª–∏—Ñ, –ò–ª–∞–π –£–æ–ª–ª–∞–∫</p>
    <p id="viewCount"><b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> 0</p>
    <div id="avgRating">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê0.0</div>
    <div>
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
      <span id="votes">(0 –≥–æ–ª–æ—Å–æ–≤)</span>
    </div>
  </div>
</div>

<div class="description">
–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä—ë—Ö –æ—Ö–æ—Ç–Ω–∏–∫–æ–≤ –∑–∞ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∞ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –≤–æ–π–Ω—ã –≤ –°–®–ê.
</div>

<!-- –í–∏–¥–µ–æ -->
<div class="video-container">
  <iframe src="https://www.youtube.com/embed/0Bwxz16-T04" allowfullscreen></iframe>
</div>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<h3>–í—Ö–æ–¥</h3>
<input type="text" id="loginName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
<button onclick="login()">–í–æ–π—Ç–∏</button>
<p id="currentUser"></p>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
<input type="text" id="commentInput" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button id="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<div id="commentList"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===================== Firebase =====================
const firebaseConfig = {
  apiKey: "AIzaSyCTr1vgcuSEn_2Ebh2vC3k7sNYzvMoYlBo",
  authDomain: "kino-project-bf21c.firebaseapp.com",
  projectId: "kino-project-bf21c",
  storageBucket: "kino-project-bf21c.firebasestorage.app",
  messagingSenderId: "603398460201",
  appId: "1:603398460201:web:42612fab9d600222985d38"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===================== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è =====================
let currentUser = localStorage.getItem("currentUser") || null;
function login(){
  const name = document.getElementById("loginName").value.trim();
  if(!name) return;
  currentUser = name;
  localStorage.setItem("currentUser", name);
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + name;
}
if(currentUser){
  document.getElementById("currentUser").innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser;
}

// ===================== –ü—Ä–æ—Å–º–æ—Ç—Ä—ã =====================
let viewed = localStorage.getItem("viewedMovie1");

if(!viewed){
  let views = parseInt(localStorage.getItem("viewsMovie1")) || 0;
  views++;
  localStorage.setItem("viewsMovie1", views);
  localStorage.setItem("viewedMovie1", "true");
}

document.getElementById("viewCount").innerHTML =
"<b>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</b> " + (localStorage.getItem("viewsMovie1") || 0);


// ===================== –†–µ–π—Ç–∏–Ω–≥ =====================
const stars = document.querySelectorAll('.star');
function loadRating(){
  db.collection('rating').doc('movie1').get().then(doc=>{
    if(doc.exists){
      const data = doc.data();
      const avg = data.totalVotes ? (data.totalScore/data.totalVotes).toFixed(1) : "0.0";
      document.getElementById('votes').innerText = `(${data.totalVotes || 0} –≥–æ–ª–æ—Å–æ–≤)`;
      document.getElementById('avgRating').innerText = `–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê${avg}`;
    }
  });
}
stars.forEach(star=>{
  star.addEventListener('click', ()=>{
    if(localStorage.getItem("rated")) return;
    const val = parseInt(star.getAttribute('data-value'));
    const ref = db.collection('rating').doc('movie1');
    db.runTransaction(async t=>{
      const doc = await t.get(ref);
      if(!doc.exists) t.set(ref,{totalVotes:1,totalScore:val});
      else t.update(ref,{
        totalVotes: (doc.data().totalVotes || 0)+1,
        totalScore: (doc.data().totalScore || 0)+val
      });
    }).then(()=>{localStorage.setItem('rated',true); loadRating();});
  });
});
loadRating();

// ===================== –°–ª–∞–π–¥–µ—Ä =====================
let index=0;
function moveSlide(step){
  const slides = document.getElementById("slides");
  const total = slides.children.length;
  const width = slides.children[0].offsetWidth + 15;
  index += step;
  if(index<0) index=total-1;
  if(index>=total) index=0;
  slides.style.transform = "translateX(-"+index*width+"px)";
}

// ===================== –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ =====================

// –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
document.getElementById("sendComment").addEventListener("click", async ()=>{
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

  const text = document.getElementById("commentInput").value.trim();
  if(!text) return;

  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes: 0,
    dislikes: 0,
    parentId: null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("commentInput").value="";
});


// –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
db.collection("comments").orderBy("timestamp","asc")
.onSnapshot(snapshot=>{
  const container = document.getElementById("commentList");
  container.innerHTML="";

  const all = {};
  snapshot.forEach(doc=>{
    all[doc.id] = {
      id: doc.id,
      ...doc.data(),
      replies:[]
    };
  });

  // —Å—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ
  Object.values(all).forEach(c=>{
    if(c.parentId){
      if(all[c.parentId]){
        all[c.parentId].replies.push(c);
      }
    }
  });

  // –≤—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤—ã–µ
  Object.values(all)
    .filter(c=>!c.parentId)
    .forEach(c=>{
      container.appendChild(createComment(c,0));
    });
});


// –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function createComment(c, level){
  const div = document.createElement("div");
  div.className="comment";
  div.style.marginLeft = (level*25)+"px";
  div.id="comment-"+c.id;

  div.innerHTML = `
    <b>${c.name}</b>: ${c.text}<br>
    <button onclick="likeComment('${c.id}')">üëç ${c.likes || 0}</button>
    <button onclick="dislikeComment('${c.id}')">üëé ${c.dislikes || 0}</button>
    <button onclick="replyComment('${c.id}','${c.name}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    ${c.name === currentUser ? `<button onclick="deleteComment('${c.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ``}
  `;

  // üëá –í–ê–ñ–ù–û: –æ—Ç–≤–µ—Ç—ã –∏–¥—É—Ç –°–ù–ò–ó–£
  if(c.replies.length){
    c.replies.forEach(r=>{
      div.appendChild(createComment(r, level+1));
    });
  }

  return div;
}


async function likeComment(id){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");

  const ref = db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;

    let likedBy = doc.data().likedBy || [];

    if(likedBy.includes(currentUser)) return;

    t.update(ref,{
      likes:(doc.data().likes || 0)+1,
      likedBy:[...likedBy, currentUser]
    });
  });
}

async function dislikeComment(id){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");

  const ref = db.collection("comments").doc(id);

  await db.runTransaction(async t=>{
    const doc = await t.get(ref);
    if(!doc.exists) return;

    let dislikedBy = doc.data().dislikedBy || [];

    if(dislikedBy.includes(currentUser)) return;

    t.update(ref,{
      dislikes:(doc.data().dislikes || 0)+1,
      dislikedBy:[...dislikedBy, currentUser]
    });
  });
}

// –û—Ç–≤–µ—Ç
function replyComment(parentId,name){
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

  const text = prompt("–û—Ç–≤–µ—Ç –¥–ª—è " + name + ":");
  if(!text) return;

  db.collection("comments").add({
    name: currentUser,
    text: text,
    likes: 0,
    dislikes: 0,
    parentId: parentId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  setTimeout(()=>{
    const el = document.getElementById("comment-"+parentId);
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  },300);
}


// –£–¥–∞–ª–µ–Ω–∏–µ —Å –¥–µ—Ä–µ–≤–æ–º
async function deleteComment(id){

  // —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ
  const snapshot = await db.collection("comments")
      .where("parentId","==",id)
      .get();

  for(const doc of snapshot.docs){
    await deleteComment(doc.id);
  }

  await db.collection("comments").doc(id).delete();
}
let replyParentId = null;

function replyComment(parentId,name){
  if(!currentUser){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

  replyParentId = parentId;
  document.getElementById("replyModal").style.display="flex";

  setTimeout(()=>{
    document.getElementById("replyModal")
      .scrollIntoView({behavior:"smooth",block:"center"});
  },200);
}

function closeReply(){
  document.getElementById("replyModal").style.display="none";
  document.getElementById("replyText").value="";
  replyParentId=null;
}

async function sendReply(){
  const text = document.getElementById("replyText").value.trim();
  if(!text) return;

  await db.collection("comments").add({
    name: currentUser,
    text: text,
    likes:0,
    dislikes:0,
    likedBy:[],
    dislikedBy:[],
    parentId: replyParentId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  closeReply();

  setTimeout(()=>{
    const el = document.getElementById("comment-"+replyParentId);
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  },300);
}

</script>
</div>
</body>
</html>
